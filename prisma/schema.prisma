// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URI")
}

enum JobType {
  FULL_TIME @map("full-time")
  PART_TIME @map("part-time")
  CONTRACT  @map("contract")
  REMOTE    @map("remote")
}

enum JobStatus {
  PENDING  @map("pending")
  APPROVED @map("approved")
  REJECTED @map("rejected")
}

enum ConsultationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum UserRole {
  USER
  ADMIN
  CONSULTANT
}

enum SaleStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PackageType {
  STANDARD // 5-7 days - R2,000
  PRIORITY // 3-4 days - R2,500
  URGENT // 1-2 days - R3,000
}

// Updated User model with admin fields
model User {
  id           String  @id @default(cuid())
  email        String  @unique
  name         String?
  firstName    String?
  lastName     String?
  phone        String?
  photoUrl     String?
  address      String?
  location     String?
  city         String?
  country      String?
  jobTitle     String?
  linkedin     String?
  github       String?
  twitter      String?
  portfolioUrl String?

  // NEW: Role and admin fields
  role    UserRole @default(USER)
  isAdmin Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  linkedinProfiles    LinkedinProfile[]
  optimizationReports OptimizationReport[]
  consultationOrders  ConsultationOrder[]
  bookmarks           Bookmark[]
  jobApplications     JobApplication[]
  savedSearches       SavedSearch[]
  jobAlerts           JobAlert[]

  @@index([email])
  @@index([role])
  @@index([isAdmin])
  @@map("users")
}

model Resume {
  id           String  @id @default(cuid())
  userId       String
  title        String?
  jobTitle     String?
  description  String?
  photoUrl     String?
  colorHex     String  @default("#000000")
  borderStyle  String  @default("solid")
  summary      String?
  firstName    String?
  lastName     String?
  email        String?
  phone        String?
  address      String?
  location     String?
  city         String?
  country      String?
  linkedin     String?
  github       String?
  twitter      String?
  portfolioUrl String?

  workExperiences      WorkExperience[]
  educations           Education[]
  certifications       Certification[]
  hardSkills           HardSkill[]
  softSkills           SoftSkill[]
  projectsPublications ProjectsPublication[]
  awards               Award[]
  jobApplications      JobApplication[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("resumes")
}

model WorkExperience {
  id String @id @default(cuid())

  position    String?
  company     String?
  description String?
  startDate   String?
  endDate     String?

  resumeId String
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("work_experiences")
}

model Education {
  id            String  @id @default(cuid())
  leadId        String?
  institution   String?
  qualification String?
  city          String?
  country       String?
  startDate     String?
  endDate       String?

  resumeId String
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("educations")
}

model HardSkill {
  id    String  @id @default(cuid())
  title String?

  resumeId String
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("hard_skills")
}

model SoftSkill {
  id    String  @id @default(cuid())
  title String?

  resumeId String
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("soft_skills")
}

model Certification {
  id String @id @default(cuid())

  body          String?
  certification String?

  year String?

  resumeId String
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("certifications")
}

model ProjectsPublication {
  id              String  @id @default(cuid())
  title           String?
  description     String?
  link            String?
  type            String?
  publisher       String?
  publicationDate String?

  resumeId String
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("projects-publications")
}

model Award {
  id          String  @id @default(cuid())
  title       String?
  description String?
  issuer      String?
  date        String?

  resumeId String
  resume   Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("awards")
}

model LinkedinProfile {
  id           String    @id @default(cuid())
  userId       String
  email        String
  name         String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  headline     String?
  summary      String?
  location     String?
  industry     String?
  experiences  Json?
  education    Json?
  skills       Json?
  profileUrl   String?
  profilePdf   String?
  lastAnalyzed DateTime?
  profileScore Int?

  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  optimizationReports OptimizationReport[]

  @@map("linkedin_profiles")
}

model OptimizationReport {
  id                    String   @id @default(cuid())
  userId                String
  email                 String
  linkedinProfileId     String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  overallScore          Int // 0-100
  headlineScore         Int? // 0-100
  summaryScore          Int? // 0-100
  experienceScore       Int? // 0-100
  skillsScore           Int? // 0-100
  keywordAnalysis       Json? // Missing keywords, suggestions
  structureAnalysis     Json? // Profile completeness check
  readabilityScore      Json? // Readability metrics
  resumeAlignment       Json? // Alignment with user's resumes
  headlineSuggestions   Json?
  summarySuggestions    Json?
  experienceSuggestions Json?
  skillSuggestions      Json?
  reportGenerated       Boolean  @default(false)
  reportUrl             String? // Path to generated PDF report

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  linkedinProfile LinkedinProfile @relation(fields: [linkedinProfileId], references: [id], onDelete: Cascade)

  @@map("optimization_reports")
}

model ConsultationOrder {
  id                 String             @id @default(cuid())
  userId             String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  consultationStatus ConsultationStatus @default(PENDING)
  amount             Int // Amount in cents (R2000 = 200000)
  currency           String             @default("ZAR")
  consultationType   String             @default("linkedin_optimization")
  requirements       Json? // Special requirements from user
  consultantId       String?
  deliveredAt        DateTime?
  deliveryUrl        String?
  consultantNotes    String?
  paymentId          String?
  paymentStatus      PaymentStatus      @default(PENDING)
  clientName         String
  clientEmail        String

  consultant Consultant? @relation(fields: [consultantId], references: [id], onDelete: SetNull)
  sale       Sale? // Link to Sale if this came from a lead conversion
  user       User?       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("consultation_orders")
}

model Consultant {
  id              String   @id @default(cuid())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  name            String
  email           String   @unique
  phone           String?
  avatar          String?
  title           String?
  bio             String?
  specializations Json?
  skills          Json?
  experience      Int?
  isActive        Boolean  @default(true)
  maxOrders       Int      @default(5)
  hourlyRate      Int?
  totalOrders     Int      @default(0)
  completedOrders Int      @default(0)
  averageRating   Float?
  availability    Json?

  consultationOrders ConsultationOrder[]
  sales              Sale[] // NEW: Track sales by agent

  @@map("consultants")
}

model Job {
  id               String    @id @default(cuid())
  title            String?
  company          String?
  companyLogo      String?
  industry         String?   @map("industry")
  firstName        String?   @map("first_name")
  lastName         String?   @map("last_name")
  companyEmail     String?   @map("company_email")
  companyPhone     String?   @map("company_phone")
  companyContact   String?   @map("company_contact")
  posterPosition   String?   @map("poster_position")
  businessLocation String?   @map("business_location")
  openingDate      DateTime  @map("opening_date")
  closingDate      DateTime  @map("closing_date")
  location         String?
  jobType          JobType   @map("job_type")
  salaryMin        Float?    @map("salary_min")
  salaryMax        Float?    @map("salary_max")
  currency         String?   @default("USD")
  skills           String[]  @default([])
  description      String?
  requirements     String?
  benefits         String?
  experienceLevel  String?   @map("experience_level")
  educationLevel   String?   @map("education_level")
  applicationUrl   String?   @map("application_url")
  userId           String    @map("user_id")
  userEmail        String?   @map("user_email")
  status           JobStatus @default(PENDING)
  isPromoted       Boolean   @default(false) @map("is_promoted")
  promotedUntil    DateTime? @map("promoted_until")
  viewCount        Int       @default(0) @map("view_count")
  applicationCount Int       @default(0) @map("application_count")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  approvedAt       DateTime? @map("approved_at")
  approvedBy       String?   @map("approved_by")

  bookmarks    Bookmark[]
  applications JobApplication[]

  @@index([industry])
  @@index([location])
  @@index([jobType])
  @@index([salaryMin, salaryMax])
  @@index([status])
  @@index([createdAt])
  @@map("jobs")
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  jobId     String
  createdAt DateTime @default(now())

  job  Job  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, jobId])
  @@index([userId])
  @@index([jobId])
  @@map("bookmarks")
}

model JobApplication {
  id          String   @id @default(cuid())
  jobId       String
  userId      String
  resumeId    String?
  coverLetter String?
  status      String   @default("PENDING")
  appliedAt   DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  job    Job     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  resume Resume? @relation(fields: [resumeId], references: [id], onDelete: SetNull)

  @@unique([jobId, userId])
  @@index([jobId])
  @@index([userId])
  @@index([status])
  @@map("job_applications")
}

model SavedSearch {
  id          String   @id @default(cuid())
  userId      String
  title       String
  searchQuery Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("saved_searches")
}

model JobAlert {
  id          String   @id @default(cuid())
  userId      String
  title       String
  criteria    Json
  isActive    Boolean  @default(true)
  frequency   String   @default("DAILY") // DAILY, WEEKLY, INSTANT
  lastSent    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  @@map("job_alerts")
}

model Lead {
  id               String   @id @default(cuid())
  email            String   @unique
  phone            String?
  headline         String?
  profileUrl       String?
  location         String?
  industry         String?
  summary          String?
  skills           String[]
  overallScore     Int
  headlineScore    Int
  summaryScore     Int
  experienceScore  Int
  skillsScore      Int
  marketingConsent Boolean  @default(false)
  contacted        Boolean  @default(false)
  converted        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  experiences   Experience[]
  linkEducation LinkEducation[]
  sales         Sale[]

  @@index([email])
  @@index([createdAt])
  @@index([overallScore])
  @@index([contacted])
  @@index([converted])
  @@map("leads")
}

model LinkEducation {
  id        String   @id @default(cuid())
  leadId    String
  school    String
  degree    String?
  field     String?
  startYear String?
  endYear   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@map("link_educations")
}

model Experience {
  id          String   @id @default(cuid())
  leadId      String
  title       String
  company     String
  location    String?
  startDate   String?
  endDate     String?
  current     Boolean  @default(false)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@map("experiences")
}

model Sale {
  id     String @id @default(cuid())
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Customer details (for historical tracking)
  customerName  String
  customerEmail String
  customerPhone String?

  // Sale details
  packageType PackageType
  amount      Int
  currency    String      @default("ZAR")
  status      SaleStatus  @default(PENDING)

  // Link to consultation order (when created)
  consultationOrderId String?            @unique
  consultationOrder   ConsultationOrder? @relation(fields: [consultationOrderId], references: [id], onDelete: SetNull)

  // Agent/Consultant tracking
  agentId    String?
  agentName  String?
  consultant Consultant? @relation(fields: [agentId], references: [id], onDelete: SetNull)

  // Payment details
  paymentMethod    String?
  paymentReference String?
  paidAt           DateTime?

  // Service delivery
  deliveryDeadline DateTime?
  completedAt      DateTime?

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
  @@index([agentId])
  @@index([status])
  @@index([createdAt])
  @@index([packageType])
  @@map("sales")
}
